name: ðŸ” Test GitHub Actions SSH

on:
  workflow_dispatch:  # Manual trigger only (no auto-run on push)

jobs:
  test-ssh:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup SSH Key from Secret
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          mkdir -p ~/.ssh
          # IMPORTANT: Preserve newlines in secret
          echo "$DEPLOY_KEY" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ls -la ~/.ssh/
          echo "âœ“ Key installed (size: $(wc -c < ~/.ssh/id_rsa) bytes)"
          
      - name: Scan Host Key (Port 2200)
        run: |
          ssh-keyscan -p 2200 38.242.218.74 2>&1 || true
          ssh-keyscan -p 2200 38.242.218.74 >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
      - name: ðŸ”¥ VERBOSE SSH TEST (Shows exact auth failure)
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
        run: |
          echo "=== Attempting SSH connection to port 2200 ==="
          ssh -vvv -o StrictHostKeyChecking=no -o ConnectTimeout=15 -p 2200 root@38.242.218.74 "echo 'âœ“ SUCCESS: Authenticated!'" 2>&1 || echo "âœ— FAILED: Check logs above for 'Permission denied' or 'Server refused our key'"
